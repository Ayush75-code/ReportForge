# Operational Procedures

## 1. STANDARD OPERATING PROCEDURES (SOPs)

### SOP-001: CSV Upload & Validation Process
**Objective:** Ensure all uploaded CSV files meet Meta Ads format requirements before consuming API resources.
**Scope:** Applies to all CSV uploads via `/api/reports/upload` endpoint.

**Procedure:**
**Step 1: Pre-Upload Validation (Client-Side)**
1.  **Check file extension:**
    *   ACCEPT: `.csv` only
    *   REJECT: `.xls`, `.xlsx`, `.txt` with message: "Please upload a CSV file."
2.  **Check file size:**
    *   ACCEPT: ≤ 10 MB
    *   REJECT: > 10 MB with message: "File too large. Please contact support."
3.  **Display loading indicator:** "Uploading and validating..."

**Step 2: Server-Side Validation**
1.  **Parse CSV headers:** Use PapaParse (config: `{ header: true, skipEmptyLines: true }`). Timeout 5s.
2.  **Validate required columns (exact match):**
    *   Campaign Name, Impressions, Clicks, Spend, Conversions, CPC, CTR, CPA
    *   IF missing: RETURN error with list of missing columns.
3.  **Validate data types:**
    *   Impressions > 0, Spend ≥ 0, Conversions ≥ 0.
    *   IF invalid: RETURN error identifying specific row and field.
4.  **Business logic:**
    *   IF `total_spend` = 0: REJECT ("No ad spend detected").
    *   IF `total_impressions` < 1000: WARNING ("Low volume").
5.  **Store validated data:** Insert into `reports` table with status 'draft'.

**Completion Criteria:** Report record exists with status='draft' and user sees success message.

---

### SOP-002: AI-Powered Report Analysis Process
**Objective:** Generate structured marketing insights from validated Meta Ads data using AI.
**Scope:** Applies to reports with status='draft'.

**Procedure:**
**Step 1: Initiate Analysis**
1.  User clicks "Generate Report".
2.  Check lock: IF status='processing', RETURN 409.
3.  Set lock: UPDATE status='processing'.

**Step 2: Prepare AI Prompt**
1.  Retrieve CSV data from `reports` table.
2.  Calculate aggregate metrics (Total Spend, Overall CPA, etc.).
3.  Construct Prompt (See `docs/01-SYSTEM-PROMPTS.md`).

**Step 3: Call OpenAI API**
1.  **Model:** `gpt-4o-mini`.
2.  **Retries:** IF JSON parse fails, retry once with stricter prompt.
3.  **Timeout:** 25 seconds.

**Step 4: Handle Outcome**
*   **Success:** UPDATE `reports` with `ai_analysis` JSON, status='completed'.
*   **Failure:** UPDATE status='failed', trigger Escalation (SOP-005).

---

### SOP-003: PDF Report Generation
**Objective:** Convert AI-generated analysis into a professionally branded PDF.
**Scope:** Applies to reports with status='completed'.

**Procedure:**
**Step 1: Retrieve Data**
1.  Fetch `ai_analysis`, `client_name`, `agency_branding` (Logo, Color).
2.  Validate logo URL (HEAD request). Fallback to text if broken.

**Step 2: Compose PDF**
1.  Use `@react-pdf/renderer`.
2.  **Layout:**
    *   Header: Logo + Report Title.
    *   Body: Executive Summary (Box), Wins (Checkmarks), Concerns (Warnings), Recommendations (Numbers).
    *   Footer: "Generated by {Agency}".
3.  **Render:** Generate PDF Buffer (Max 10s).

**Step 3: Upload to Storage**
1.  Upload to Supabase Storage bucket `reports`. Filename: `{report_id}.pdf`.
2.  Get Public URL.
3.  UPDATE `reports` table with `pdf_url`.

**Step 4: Delivery**
1.  Return `pdf_url` to frontend.
2.  Increment `reports_used_this_month` counter.

---

### SOP-004: Usage Limit Enforcement
**Objective:** Prevent abuse and enforce plan limits.

**Procedure:**
1.  **Check Limit:** query `agencies.reports_used_this_month` vs `plan_limit`.
    *   Starter: 20
    *   Pro: 100
2.  **Actions:**
    *   IF `used >= limit`: BLOCK generation. Show "Upgrade" prompt.
    *   IF `used < limit`: ALLOW.
3.  **Reset:** Scheduled job (Cron) resets counters on 1st of month.

---

### SOP-005: Failed Report Recovery
**Objective:** Handle reports stuck in 'failed' state.

**Procedure:**
1.  **Automated Retry:** Background job runs every 15 mins. Retries failed reports (Max 3 attempts).
2.  **Escalation:** IF 3rd retry fails:
    *   Set status: 'requires_manual_review'.
    *   Alert Support (Slack/Email).
    *   Notify User: "We are reviewing your report."
3.  **Manual Resolution:** Support Agent fixes CSV or resets status.

---

## 2. ESCALATION MATRIX

| Issue Type | Severity | Response SLA | Primary Contact |
| :--- | :--- | :--- | :--- |
| **System Outage** | P0 (Critical) | 15 min | Engineering On-Call |
| **Security Breach** | P0 (Critical) | 30 min | Security Officer / CTO |
| **Payment Failure** | P1 (Urgent) | 2 hours | Billing Support |
| **Failed Report** | P2 (High) | 2 hours | Support Team |
| **Bug / Feedback** | P3 (Low) | 24 hours | Product Backlog |

### Escalation Protocols
*   **P0:** PagerDuty + Slack `#engineering-oncall`. Status Page Update.
*   **P1:** Slack `#billing-support`. Email Finance.
*   **P2:** Support Ticket. Slack `#support-alerts`.
*   **P3:** Log in backlog. Weekly review.

---

## 3. COMPLIANCE & POLICIES

### Data Handling (GDPR/CCPA)
*   **Data Minimization:** We only collect Email, Agency Name, Client Name, and Ads Data. No PII of end-consumers.
*   **Purpose:** Data is used ONLY for generating reports. NOT for training public models.
*   **Retention:**
    *   Reports: 12 months.
    *   CSV Uploads: Deleted after 30 days.
    *   Deleted Accounts: All data erased after 30 days.

### Acceptable Use
*   **Allowed:** Generating reports for clients, internal review.
*   **Prohibited:** Reselling raw access, scraping, uploading illegal content.
*   **Abuse:** Excessive API calls (>100/hr) may trigger temporary suspension.

### AI Disclaimer
"AI Analysis is NOT perfect. Users are responsible for reviewing reports before sending to clients. We are not liable for business decisions made based on AI insights."
